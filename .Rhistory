End_spawn = if_else(End_spawn < Start_spawn & sample_datetime >= End_spawn, End_spawn + years(1), # add a year if in spawn period carrying to next year
End_spawn), # otherwise, keep End_spawn as current year
Start_spawn = if_else(End_spawn < Start_spawn & sample_datetime <= End_spawn, Start_spawn - years(1), # subtract a year if in spawn period carrying from previous year
Start_spawn),
in_spawn = ifelse(sample_datetime >= spawn_start & sample_datetime <= spawn_end & !is.na(spawn_start), 1, 0 ),
critstart = mdy(paste0("7/1/",year(sample_datetime) )),
critend = mdy(paste0("9/30/",year(sample_datetime) )),
is.crit = ifelse(sample_datetime >= critstart & sample_datetime <= critend, 1, 0 )) %>%
filter(!is.null(OWRD_Basin) & DO_code %in% c(2,3,4))
# add spawn start and end dates as dates, include indicator if actdate is within spawn
# add critical period start and end dates, include indicator is actdate is within critperiod
Results_spawndates <- df %>%
mutate(Start_spawn = ifelse(!is.na(spawn_start), paste0(spawn_start, "/",year(sample_datetime) ), spawn_start ),
End_spawn= ifelse(!is.na(spawn_end), paste0(spawn_end, "/", year(sample_datetime)), spawn_end ),
Start_spawn = mdy(Start_spawn),
End_spawn = mdy(End_spawn),
End_spawn = if_else(End_spawn < Start_spawn & sample_datetime >= End_spawn, End_spawn + years(1), # add a year if in spawn period carrying to next year
End_spawn), # otherwise, keep End_spawn as current year
Start_spawn = if_else(End_spawn < Start_spawn & sample_datetime <= End_spawn, Start_spawn - years(1), # subtract a year if in spawn period carrying from previous year
Start_spawn),
in_spawn = ifelse(sample_datetime >= spawn_start & sample_datetime <= spawn_end & !is.na(spawn_start), 1, 0 ),
critstart = mdy(paste0("7/1/",year(sample_datetime) )),
critend = mdy(paste0("9/30/",year(sample_datetime) )),
is.crit = ifelse(sample_datetime >= critstart & sample_datetime <= critend, 1, 0 ))
# add spawn start and end dates as dates, include indicator if actdate is within spawn
# add critical period start and end dates, include indicator is actdate is within critperiod
Results_spawndates <- df %>%
mutate(Start_spawn = ifelse(!is.na(spawn_start), paste0(spawn_start, "/",year(sample_datetime) ), spawn_start ),
End_spawn= ifelse(!is.na(spawn_end), paste0(spawn_end, "/", year(sample_datetime)), spawn_end ),
Start_spawn = mdy(Start_spawn),
End_spawn = mdy(End_spawn),
End_spawn = if_else(End_spawn < Start_spawn & sample_datetime >= End_spawn, End_spawn + years(1), # add a year if in spawn period carrying to next year
End_spawn), # otherwise, keep End_spawn as current year
Start_spawn = if_else(End_spawn < Start_spawn & sample_datetime <= End_spawn, Start_spawn - years(1), # subtract a year if in spawn period carrying from previous year
Start_spawn),
in_spawn = ifelse(sample_datetime >= Start_spawn & sample_datetime <= End_spawn & !is.na(Start_spawn), 1, 0 ),
critstart = mdy(paste0("7/1/",year(sample_datetime) )),
critend = mdy(paste0("9/30/",year(sample_datetime) )),
is.crit = ifelse(sample_datetime >= critstart & sample_datetime <= critend, 1, 0 ))
# Summarize available data to get a list of AU's to be analyzed using cont. data
results_cont_summary <- Results_spawndates %>%
filter(Statistical_Base == "30DADMean") %>%
group_by(MLocID) %>%
summarise(tot_30d_metrics = n(),
crit_30d_periods = sum(is.crit)) %>%
filter(crit_30d_periods >= 15,
!is.na(MLocID))
View(results_cont_summary)
# filter down to AUs that are to be evaluated with cont metrics
# Filter down to only 30-D, 7-Mi, and daily minimums
# Flag various violations
continuous_data_analysis <- Results_spawndates %>%
filter(MLocID %in% results_cont_summary$MLocID) %>%
filter(Statistical_Base %in% c("30DADMean", "7DADMin", "Minimum")) %>%
mutate(Violation = ifelse(Statistical_Base == "30DADMean" & IRResultNWQSunit < crit_30D, 1,
ifelse(Statistical_Base == "7DADMin" & IRResultNWQSunit < crit_7Mi, 1,
ifelse(Statistical_Base == "Minimum" & IRResultNWQSunit < crit_Min, 1, 0 ))))
View(clack_data_DO)
# filter down to AUs that are to be evaluated with cont metrics
# Filter down to only 30-D, 7-Mi, and daily minimums
# Flag various violations
continuous_data_analysis <- Results_spawndates %>%
filter(MLocID %in% results_cont_summary$MLocID) %>%
filter(Statistical_Base %in% c("30DADMean", "7DADMin", "Minimum")) %>%
mutate(Violation = ifelse(Statistical_Base == "30DADMean" & Result_cen < crit_30D, 1,
ifelse(Statistical_Base == "7DADMin" & Result_cen < crit_7Mi, 1,
ifelse(Statistical_Base == "Minimum" & Result_cen < crit_Min, 1, 0 ))))
View(clack_data_DO)
# filter down to AUs that are to be evaluated with cont metrics
# Filter down to only 30-D, 7-Mi, and daily minimums
# Flag various violations
continuous_data_analysis <- Results_spawndates %>%
filter(MLocID %in% results_cont_summary$MLocID) %>%
filter(Statistical_Base %in% c("30DADMean", "7DADMin", "Minimum")) %>%
mutate(Violation = ifelse(Statistical_Base == "30DADMean" & Result_cen < Do_crit_30D, 1,
ifelse(Statistical_Base == "7DADMin" & Result_cen < Do_crit_7Mi, 1,
ifelse(Statistical_Base == "Minimum" & Result_cen < DO_crit_min, 1, 0))))
View(continuous_data_analysis)
AWQMSdata::DO_crit
AWQMSdata::LU_DOCode
df$DO_Class <- LU_DOCode[match(df$DO_code, LU_DOCode$DO_code), "DO_Class"]
# add spawn start and end dates as dates, include indicator if actdate is within spawn
# add critical period start and end dates, include indicator is actdate is within critperiod
Results_spawndates <- df %>%
mutate(Start_spawn = ifelse(!is.na(spawn_start), paste0(spawn_start, "/",year(sample_datetime) ), spawn_start ),
End_spawn= ifelse(!is.na(spawn_end), paste0(spawn_end, "/", year(sample_datetime)), spawn_end ),
Start_spawn = mdy(Start_spawn),
End_spawn = mdy(End_spawn),
End_spawn = if_else(End_spawn < Start_spawn & sample_datetime >= End_spawn, End_spawn + years(1), # add a year if in spawn period carrying to next year
End_spawn), # otherwise, keep End_spawn as current year
Start_spawn = if_else(End_spawn < Start_spawn & sample_datetime <= End_spawn, Start_spawn - years(1), # subtract a year if in spawn period carrying from previous year
Start_spawn),
in_spawn = ifelse(sample_datetime >= Start_spawn & sample_datetime <= End_spawn & !is.na(Start_spawn), 1, 0 ),
critstart = mdy(paste0("7/1/",year(sample_datetime) )),
critend = mdy(paste0("9/30/",year(sample_datetime) )),
is.crit = ifelse(sample_datetime >= critstart & sample_datetime <= critend, 1, 0 ))
# Summarize available data to get a list of AU's to be analyzed using cont. data
results_cont_summary <- Results_spawndates %>%
filter(Statistical_Base == "30DADMean") %>%
group_by(MLocID) %>%
summarise(tot_30d_metrics = n(),
crit_30d_periods = sum(is.crit)) %>%
filter(crit_30d_periods >= 15,
!is.na(MLocID))
# filter down to AUs that are to be evaluated with cont metrics
# Filter down to only 30-D, 7-Mi, and daily minimums
# Flag various violations
continuous_data_analysis <- Results_spawndates %>%
filter(MLocID %in% results_cont_summary$MLocID) %>%
filter(Statistical_Base %in% c("30DADMean", "7DADMin", "Minimum")) %>%
mutate(Violation = ifelse(Statistical_Base == "30DADMean" & Result_cen < Do_crit_30D, 1,
ifelse(Statistical_Base == "7DADMin" & Result_cen < Do_crit_7Mi, 1,
ifelse(Statistical_Base == "Minimum" & Result_cen < DO_crit_min, 1, 0))))
# Run through initial categorization
# This all gets redone in the end
# Where percent saturation would make a difference, set category as "Check percent Sat"
continuous_data_categories <- continuous_data_analysis %>%
group_by(MLocID, DO_Class) %>%
summarise(Total_violations = sum(Violation),
Sum_30D_violations = sum(Violation [Statistical_Base == "30DADMean"]),
Sum_7mi_violations = sum(Violation [Statistical_Base == "7DADMin"]),
Sum_abs_min_violations = sum(Violation [Statistical_Base == "Minimum"])) %>%
mutate(IR_category = ifelse(DO_Class != "Cold Water" &
(Sum_30D_violations >= 2 |
Sum_7mi_violations >= 2 |
Sum_abs_min_violations >= 2), "Cat 5",
ifelse(DO_Class == "Cold Water" &
(Sum_7mi_violations >= 2 |
Sum_abs_min_violations >= 2), "Cat 5",
ifelse(DO_Class == "Cold Water" &
Sum_30D_violations >= 2 &
Sum_7mi_violations < 2 &
Sum_abs_min_violations < 2, "Check percent Sat",
ifelse(Sum_30D_violations < 2 &
Sum_7mi_violations < 2 &
Sum_abs_min_violations < 2, "Cat 2", "Error" )))))
# Datatable of results that need percent saturation
cont_perc_sat_check <- continuous_data_analysis %>%
filter(MLocID %in% unique(subset(continuous_data_categories, IR_category == "Check percent Sat" )$MLocID) )
library(rgdal)
library(RODBC)
library(dplyr)
# devtools::install_github('https://github.com/donco/odeqstatusandtrends')
library(odeqstatusandtrends)
# devtools::install_github('https://github.com/donco/odeqassessment')
library(odeqassessment)
# devtools::install_github('https://github.com/TravisPritchardODEQ/IR2018/tree/master/IRlibrary')
library(AWQMSdata)
# library(IRlibrary)
library(dataRetrieval)
library(ggplot2)
library(lubridate)
library(pbapply)
library(parallel)
start.date = "2000-01-01"
end.date = "2019-01-01"
Name <- "Clackamas"
# support_files_dir <- "//deqhq1/GISLIBRARY/Base_Data/Hydrography/Watershed_Boundaries/WBD_OR.gdb/WBD_OR.gdb/WBD_OR"
basin_shp <- readOGR(dsn = "//deqhq1/GISLIBRARY/Base_Data/Hydrography/Watershed_Boundaries/WBD_OR.gdb/WBD_OR.gdb",
layer = 'WBD_HU8', integer64="warn.loss", verbose = FALSE)
basin_shp <- basin_shp[basin_shp$HU_8_NAME %in% c("Clackamas", "South Santiam", "Wilson-Trask-Nestucca", "Coast Fork Willamette"), ]
clack_stations_AWQMS <- get_stations_AWQMS(basin_shp)
# ss_stations_NWIS <- get_stations_NWIS(agwqma_shp)
clack_data_raw <- GetData(parameters = c("Temperature", "Bacteria", "TSS", "DO", "TP", "pH"),
stations_AWQMS = clack_stations_AWQMS,
# stations_NWIS = ss_stations_NWIS,
start.date = start.date,
end.date = end.date)
ent_data <- AWQMSdata::AWQMS_Data(startdate = start.date, enddate = end.date, char = "Enterococcus")
clack_data_raw <- bind_rows(clack_data_raw, ent_data)
clack_data <- CleanData(clack_data_raw)
clack_data <- add_criteria(clack_data)
clack_data_pH <- clack_data %>% filter(Char_Name == "pH")
clack_data_pH <- Censored_data(clack_data_pH, criteria = 'pH_Min')
clack_data_pH <- pH_assessment(clack_data_pH)
# clack_data_ph$exceed <- ifelse(clack_data_ph$Result_Numeric >= clack_data_ph$pH_crit_min & clack_data_ph$Result_Numeric <= clack_data_ph$pH_crit_max, FALSE, TRUE)
# clack_data_ph <- clack_data_ph %>% filter(!is.na(exceed))
clack_data_temp <- clack_data %>% filter(Char_Name == "Temperature, water")
clack_data_temp <- Censored_data(clack_data_temp, criteria = "temp_crit")
clack_data_temp <- temp_assessment(clack_data_temp)
# clack_data_temp$exceed <- ifelse(clack_data_temp$Result_Numeric >= clack_data_temp$temp_crit, TRUE, FALSE)
# clack_data_temp <- clack_data_temp %>% filter(!is.na(exceed))
clack_data_TP <- clack_data %>% filter(Char_Name == "Phosphate-phosphorus")
clack_data_TP$TP_crit <- NA
clack_data_TP <- Censored_data(clack_data_TP, criteria = "TP_crit")
clack_data_TP <- TP_assessment(clack_data_TP)
clack_data_TSS <- clack_data %>% filter(Char_Name == "Total suspended solids")
clack_data_TSS$TSS_crit <- NA
clack_data_TSS <- Censored_data(clack_data_TSS, criteria = "TSS_crit")
clack_data_TSS <- TSS_assessment(clack_data_TSS)
clack_data_bact <- clack_data %>% filter(Char_Name %in% AWQMS_Char_Names('bacteria'))
clack_data_bact <- clack_data_bact %>% mutate(bact_crit_min = pmin(bact_crit_ss, bact_crit_geomean, bact_crit_percent, na.rm = TRUE))
clack_data_bact <- Censored_data(clack_data_bact, criteria = "bact_crit_min")
clack_data_ent <- Coastal_Contact_rec(clack_data_bact)
clack_data_eco <- Fresh_Contact_rec(clack_data_bact)
clack_data_shell <- Shell_Harvest(clack_data_bact)
clack_data_DO <- clack_data %>% filter(Char_Name == "Dissolved oxygen (DO)")
clack_data_DO <- Censored_data(clack_data_DO, criteria = "DO_crit_min")
ggplot(mtcars, aes(x = mpg, y = cyl, fill = mtcars$gear))
ggplot(mtcars, aes(x = mpg, y = cyl, fill = mtcars$gear))+
geom_bar()
ggplot(mtcars, aes(x = mpg, y = cyl, fill = mtcars$gear))+
geom_bar(stat = "identity")
mtcars
ggplot(mtcars, aes(x = mpg, y = cyl, fill = row.names()))+
geom_bar(stat = "identity")
ggplot(mtcars, aes(x = mpg, y = cyl, fill = gear))+geom_bar(stat = "identity")
ggplot(mtcars, aes(x = mpg, y = cyl, fill = gear))+geom_bar(stat = "identity", position = position_dodge())
ggplot(mtcars, aes(x = mpg, y = cyl, fill = rownames(mtcars)))+geom_bar(stat = "identity", position = position_dodge())
ggplot(head(mtcars), aes(x = mpg, y = cyl, fill = rownames(head(mtcars))))+geom_bar(stat = "identity", position = position_dodge())
ggplot(head(mtcars), aes(x = mpg, y = cyl, fill = rownames(head(mtcars))))+geom_bar(stat = "identity", position = "dodge")
setwd("//deqhq1/WQNPS/Agriculture/Status_and_Trend_Analysis/StatusAndTrends_Package/odeqstatusandtrends")
getwd()
document()
devtools::document()
parameter_summary <- function(status, sea_ken, stations){
st_stations <- unique(c(status$MLocID, sea_ken$MLocID))
st_stations_info <- stations %>% dplyr::filter(MLocID %in% st_stations) %>%
dplyr::select(AU_ID, MLocID, StationDes)
param_sum <- merge(st_stations_info, status, by = "MLocID")
param_sum <- merge(param_sum, sea_ken, by = c("MLocID","Char_Name"))
param_sum <- dplyr::select(param_sum, AU_ID, Char_Name, MLocID, StationDes, status, trend)
param_sum <- param_sum[order(param_sum[,1], param_sum[,2], param_sum[,3]),]
}
library(rgdal)
library(RODBC)
library(dplyr)
# devtools::install_github('https://github.com/donco/odeqstatusandtrends')
library(odeqstatusandtrends)
# devtools::install_github('https://github.com/donco/odeqassessment')
library(odeqassessment)
# devtools::install_github('https://github.com/TravisPritchardODEQ/IR2018/tree/master/IRlibrary')
library(AWQMSdata)
# library(IRlibrary)
library(dataRetrieval)
library(ggplot2)
library(lubridate)
library(pbapply)
library(parallel)
start.date = "2000-01-01"
end.date = "2019-01-01"
Name <- "Clackamas"
# support_files_dir <- "//deqhq1/GISLIBRARY/Base_Data/Hydrography/Watershed_Boundaries/WBD_OR.gdb/WBD_OR.gdb/WBD_OR"
basin_shp <- readOGR(dsn = "//deqhq1/GISLIBRARY/Base_Data/Hydrography/Watershed_Boundaries/WBD_OR.gdb/WBD_OR.gdb",
layer = 'WBD_HU8', integer64="warn.loss", verbose = FALSE)
basin_shp <- basin_shp[basin_shp$HU_8_NAME %in% c("Clackamas", "South Santiam", "Wilson-Trask-Nestucca", "Coast Fork Willamette"), ]
clack_stations_AWQMS <- get_stations_AWQMS(basin_shp)
# ss_stations_NWIS <- get_stations_NWIS(agwqma_shp)
clack_data_raw <- GetData(parameters = c("Temperature", "Bacteria", "TSS", "DO", "TP", "pH"),
stations_AWQMS = clack_stations_AWQMS,
# stations_NWIS = ss_stations_NWIS,
start.date = start.date,
end.date = end.date)
ent_data <- AWQMSdata::AWQMS_Data(startdate = start.date, enddate = end.date, char = "Enterococcus")
clack_data_raw <- bind_rows(clack_data_raw, ent_data)
clack_data <- CleanData(clack_data_raw)
clack_data <- add_criteria(clack_data)
clack_data_pH <- clack_data %>% filter(Char_Name == "pH")
clack_data_pH <- Censored_data(clack_data_pH, criteria = 'pH_Min')
clack_data_pH <- pH_assessment(clack_data_pH)
# clack_data_ph$exceed <- ifelse(clack_data_ph$Result_Numeric >= clack_data_ph$pH_crit_min & clack_data_ph$Result_Numeric <= clack_data_ph$pH_crit_max, FALSE, TRUE)
# clack_data_ph <- clack_data_ph %>% filter(!is.na(exceed))
clack_data_temp <- clack_data %>% filter(Char_Name == "Temperature, water")
clack_data_temp <- Censored_data(clack_data_temp, criteria = "temp_crit")
clack_data_temp <- temp_assessment(clack_data_temp)
# clack_data_temp$exceed <- ifelse(clack_data_temp$Result_Numeric >= clack_data_temp$temp_crit, TRUE, FALSE)
# clack_data_temp <- clack_data_temp %>% filter(!is.na(exceed))
clack_data_TP <- clack_data %>% filter(Char_Name == "Phosphate-phosphorus")
clack_data_TP$TP_crit <- NA
clack_data_TP <- Censored_data(clack_data_TP, criteria = "TP_crit")
clack_data_TP <- TP_assessment(clack_data_TP)
clack_data_TSS <- clack_data %>% filter(Char_Name == "Total suspended solids")
clack_data_TSS$TSS_crit <- NA
clack_data_TSS <- Censored_data(clack_data_TSS, criteria = "TSS_crit")
clack_data_TSS <- TSS_assessment(clack_data_TSS)
clack_data_bact <- clack_data %>% filter(Char_Name %in% AWQMS_Char_Names('bacteria'))
clack_data_bact <- clack_data_bact %>% mutate(bact_crit_min = pmin(bact_crit_ss, bact_crit_geomean, bact_crit_percent, na.rm = TRUE))
clack_data_bact <- Censored_data(clack_data_bact, criteria = "bact_crit_min")
clack_data_ent <- Coastal_Contact_rec(clack_data_bact)
clack_data_eco <- Fresh_Contact_rec(clack_data_bact)
clack_data_shell <- Shell_Harvest(clack_data_bact)
# clack_data_bact <- bind_rows(clack_data_ent, clack_data_eco, clack_data_shell)
clack_data_DO <- clack_data %>% filter(Char_Name == "Dissolved oxygen (DO)")
clack_data_DO <- Censored_data(clack_data_DO, criteria = "DO_crit_min")
clack_data <- bind_rows(clack_data_temp, clack_data_pH, clack_data_TP, clack_data_TSS, clack_data_eco)
pH_status <- status_stns(clack_data_pH)
temp_status <- status_stns(clack_data_temp)
TP_status <- status_stns(clack_data_TP)
TSS_status <- status_stns(clack_data_TSS)
bact_status <- status_stns(clack_data_eco)
status <- bind_rows(pH_status, temp_status, TP_status, TSS_status, bact_status)
pH_trend <- trend_stns(clack_data_pH)
temp_trend <- trend_stns(clack_data_temp)
TP_trend <- trend_stns(clack_data_TP)
TSS_trend <- trend_stns(clack_data_TSS)
bact_trend <- trend_stns(clack_data_eco)
trend <- bind_rows(pH_trend, temp_trend, TP_trend, TSS_trend, bact_trend)
seaKen <- sea_ken(filter(clack_data, MLocID %in% unique(trend$MLocID)))
seaKen_sample_size <- attributes(seaKen)$sample_size
source('//deqhq1/WQNPS/Agriculture/Status_and_Trend_Analysis/odeq_assessment package/odeqassessment/R/bact_fresh_contact_rec.R', echo=TRUE)
clack_data_eco <- Fresh_Contact_rec(clack_data_bact)
pH_status <- status_stns(clack_data_pH)
temp_status <- status_stns(clack_data_temp)
TP_status <- status_stns(clack_data_TP)
TSS_status <- status_stns(clack_data_TSS)
bact_status <- status_stns(clack_data_eco)
status <- bind_rows(pH_status, temp_status, TP_status, TSS_status, bact_status)
pH_trend <- trend_stns(clack_data_pH)
temp_trend <- trend_stns(clack_data_temp)
TP_trend <- trend_stns(clack_data_TP)
TSS_trend <- trend_stns(clack_data_TSS)
bact_trend <- trend_stns(clack_data_eco)
trend <- bind_rows(pH_trend, temp_trend, TP_trend, TSS_trend, bact_trend)
seaKen <- sea_ken(filter(clack_data, MLocID %in% unique(trend$MLocID)))
seaKen_sample_size <- attributes(seaKen)$sample_size
clack_param_sum <- parameter_summary(status, seaKen, clack_stations_AWQMS)
View(clack_param_sum)
source('//deqhq1/WQNPS/Agriculture/Status_and_Trend_Analysis/StatusAndTrends_Package/odeqstatusandtrends/R/parameter_summary.R', echo=TRUE)
clack_param_sum <- parameter_summary(status, seaKen, clack_stations_AWQMS)
install.packages("sf")
library(sf)
assessment_units <- sf::st_read(
dsn = "//deqhq1/GISLIBRARY/Base_Data/DEQ_Data/Water_Quality/WQ_2018_IntegratedReport/Assessment.gdb/",
layer = AssessmentUnits_OR_Lines)
assessment_units <- sf::st_read(
dsn = "//deqhq1/GISLIBRARY/Base_Data/DEQ_Data/Water_Quality/WQ_2018_IntegratedReport/Assessment.gdb",
layer = AssessmentUnits_OR_Lines)
assessment_units <- sf::st_read(
dsn = "//deqhq1/GISLIBRARY/Base_Data/DEQ_Data/Water_Quality/WQ_2018_IntegratedReport/",
layer = AssessmentUnits_OR_Lines)
assessment_units <- sf::st_read(
dsn = "//deqhq1/GISLIBRARY/Base_Data/DEQ_Data/Water_Quality/WQ_2018_IntegratedReport",
layer = AssessmentUnits_OR_Lines)
assessment_units <- sf::st_read(
dsn = "//deqhq1/GISLIBRARY/Base_Data/DEQ_Data/Water_Quality/WQ_2018_IntegratedReport/Assessment.gdb/AssessmentUnits_OR_Lines.shp")
assessment_units <- sf::st_read("//deqhq1/GISLIBRARY/Base_Data/DEQ_Data/Water_Quality/WQ_2018_IntegratedReport/Assessment.gdb/AssessmentUnits_OR_Lines.shp")
assessment_units <- sf::st_read(
dsn = "//deqhq1/GISLIBRARY/Base_Data/DEQ_Data/Water_Quality/WQ_2018_IntegratedReport/Assessment.gdb")
assessment_units <- sf::st_read(
dsn = "//deqhq1/GISLIBRARY/Base_Data/DEQ_Data/Water_Quality/WQ_2018_IntegratedReport/Assessment.gdb",
layer = "AssessmentUnits_OR_Lines")
assessment_units <- sf::st_read(
dsn = "//deqhq1/GISLIBRARY/Base_Data/DEQ_Data/Water_Quality/WQ_2018_IntegratedReport/Assessment.gdb",
layer = "AssessmentUnits_OR_Lines")
library(sp)
library(rgdal)
install.packages("dbplyr")
library(dbplyr)
AssessmentUnits_OR_Lines %>%
select(c('AU_ID', 'AU_Name')) %>%
show_query()
AssessmentUnits_OR_Lines %>%
dbplyr::select(c('AU_ID', 'AU_Name')) %>%
dbplyr::show_query()
dbplyr::select(c('AU_ID', 'AU_Name')) %>%
dbplyr::show_query()
dbplyr::select_query(select(c('AU_ID', 'AU_Name')))
dbplyr::sql_build(select(c('AU_ID', 'AU_Name')))
parameter_summary <- clack_param_sum
param_summary <- clack_param_sum
cat("SELECT 'AU_ID', 'AU_Name' FROM 'AssessmentUnits_OR_Lines' WHERE AU_ID IN ", param_summary$AU_ID)
cat("SELECT 'AU_ID', 'AU_Name' FROM 'AssessmentUnits_OR_Lines' WHERE AU_ID IN ", paste(param_summary$AU_ID, sep = "'"))
paste(param_summary$AU_ID, sep = "'")
paste(param_summary$AU_ID, collapse = "'")
paste(param_summary$AU_ID, collapse = "', ")
cat("SELECT 'AU_ID', 'AU_Name' FROM 'AssessmentUnits_OR_Lines' WHERE AU_ID IN ", paste(param_summary$AU_ID, collapse = "', "))
cat("SELECT 'AU_ID', 'AU_Name' FROM 'AssessmentUnits_OR_Lines' WHERE AU_ID IN '",
paste(param_summary$AU_ID, collapse = "', "), "'")
cat("SELECT 'AU_ID', 'AU_Name' FROM 'AssessmentUnits_OR_Lines' WHERE AU_ID IN '",
paste(param_summary$AU_ID, collapse = "',"), "'")
assessment_units <- sf::st_read(
dsn = "//deqhq1/GISLIBRARY/Base_Data/DEQ_Data/Water_Quality/WQ_2018_IntegratedReport/Assessment.gdb",
layer = "AssessmentUnits_OR_Lines",
query = cat("SELECT 'AU_ID','AU_Name' FROM 'AssessmentUnits_OR_Lines' WHERE AU_ID IN '",
paste(param_summary$AU_ID, collapse = "',"), "'")
)
query <- cat("SELECT 'AU_ID','AU_Name' FROM 'AssessmentUnits_OR_Lines' WHERE AU_ID IN '",
paste(param_summary$AU_ID, collapse = "',"), "'")
query <- cat("SELECT 'AU_ID','AU_Name' FROM 'AssessmentUnits_OR_Lines' WHERE AU_ID IN '",
paste(param_summary$AU_ID, collapse = "',"), "'")
query <- paste0("SELECT 'AU_ID','AU_Name' FROM 'AssessmentUnits_OR_Lines' WHERE AU_ID IN '",
paste(param_summary$AU_ID, collapse = "',"), "'")
assessment_units <- sf::st_read(
dsn = "//deqhq1/GISLIBRARY/Base_Data/DEQ_Data/Water_Quality/WQ_2018_IntegratedReport/Assessment.gdb",
layer = "AssessmentUnits_OR_Lines",
query = query
)
query <- paste0("SELECT 'AU_ID','AU_Name' FROM 'AssessmentUnits_OR_Lines' WHERE 'AU_ID' IN '",
paste(param_summary$AU_ID, collapse = "',"), "'")
assessment_units <- sf::st_read(
dsn = "//deqhq1/GISLIBRARY/Base_Data/DEQ_Data/Water_Quality/WQ_2018_IntegratedReport/Assessment.gdb",
layer = "AssessmentUnits_OR_Lines",
query = query
)
query <- paste0("SELECT 'AU_ID','AU_Name' FROM 'AssessmentUnits_OR_Lines' WHERE 'AU_ID' IN ('",
paste(param_summary$AU_ID, collapse = "',"), "')")
assessment_units <- sf::st_read(
dsn = "//deqhq1/GISLIBRARY/Base_Data/DEQ_Data/Water_Quality/WQ_2018_IntegratedReport/Assessment.gdb",
layer = "AssessmentUnits_OR_Lines",
query = query
)
query <- paste0("SELECT AU_ID, AU_Name FROM AssessmentUnits_OR_Lines WHERE AU_ID IN ('",
paste(param_summary$AU_ID, collapse = "',"), "');")
assessment_units <- sf::st_read(
dsn = "//deqhq1/GISLIBRARY/Base_Data/DEQ_Data/Water_Quality/WQ_2018_IntegratedReport/Assessment.gdb",
layer = "AssessmentUnits_OR_Lines",
query = query
)
query <- paste0("SELECT AU_ID, AU_Name FROM AssessmentUnits_OR_Lines WHERE AU_ID IN ('",
paste(unique(param_summary$AU_ID), collapse = "',"), "');")
assessment_units <- sf::st_read(
dsn = "//deqhq1/GISLIBRARY/Base_Data/DEQ_Data/Water_Quality/WQ_2018_IntegratedReport/Assessment.gdb",
layer = "AssessmentUnits_OR_Lines",
query = query
)
query <- paste0("SELECT AU_ID, AU_Name FROM AssessmentUnits_OR_Lines WHERE AU_ID IN ('",
paste(unique(param_summary$AU_ID), collapse = "', '"), "');")
assessment_units <- sf::st_read(
dsn = "//deqhq1/GISLIBRARY/Base_Data/DEQ_Data/Water_Quality/WQ_2018_IntegratedReport/Assessment.gdb",
layer = "AssessmentUnits_OR_Lines",
query = query
)
query <- paste0("SELECT AU_ID, AU_Name FROM AssessmentUnits_OR_Lines WHERE AU_ID IN ('",
paste(unique(param_summary$AU_ID), collapse = "', '"), "')")
assessment_units <- sf::st_read(
dsn = "//deqhq1/GISLIBRARY/Base_Data/DEQ_Data/Water_Quality/WQ_2018_IntegratedReport/Assessment.gdb",
layer = "AssessmentUnits_OR_Lines",
query = query
)
View(assessment_units)
query <- paste0("SELECT * FROM AssessmentUnits_OR_Lines WHERE AU_ID IN ('",
paste(unique(param_summary$AU_ID), collapse = "', '"), "')")
assessment_units <- sf::st_read(
dsn = "//deqhq1/GISLIBRARY/Base_Data/DEQ_Data/Water_Quality/WQ_2018_IntegratedReport/Assessment.gdb",
layer = "AssessmentUnits_OR_Lines",
query = query
)
View(assessment_units)
au_shp <- sf::as_Spatial(assessment_units)
au_shp <- sf::as_Spatial(assessment_units, cast = TRUE)
sf::st_zm(assessment_units, what = "M")
sf::st_zm(assessment_units, what = "M")
sf::st_zm(assessment_units, what = "ZM")
assessment_units <- sf::st_zm(assessment_units, what = "ZM")
au_shp <- sf::as_Spatial(assessment_units, cast = TRUE)
sf::st_crs(au_shp)
leaflet(au_shp) %>% addTiles() %>% addPolygons()
library(leaflet)
leaflet(au_shp) %>% addTiles() %>% addPolygons()
leaflet(au_shp) %>% addTiles() %>% addPolylines()
espg4326 <- leafletCRS(crsClass = "L.Proj.CRS", code = 'EPSG:4326',
proj4def = '+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs +towgs84=0,0,0',
resolutions = c(8192, 4096, 2048))
sf::st_crs(au_shp) <- espg4326
sf::st_crs(au_shp) <- 4326
sf::st_geometry(au_shp)
st_crs(assessment_units)
leaflet(assessment_units) %>% addTiles() %>% addPolylines()
st_crs(assessment_units)
st_transform(assessment_units, 4326)
assessment_units <- st_transform(assessment_units, 4326)
st_crs(assessment_units)
leaflet(assessment_units) %>% addTiles() %>% addPolylines()
View(param_summary)
au_colors <- param_summary %>% group_by(AU_ID) %>% summarise(color = if(any(status == "Not Attaining"), "red", "green"))
au_colors <- param_summary %>% group_by(AU_ID) %>% summarise(color = ifelse(any(status == "Not Attaining"), "red", "green"))
View(au_colors)
leaflet(assessment_units) %>% addTiles() %>% addPolylines(fillOpacity = 1,
fillColor = ~au_colors[match(assessment_units$AU_ID, au_colors$AU_ID),"color"],
popup = ~paste("<b>", AU_ID, "</b><br>", AU_Name))
au_colors[match(assessment_units$AU_ID, au_colors$AU_ID),"color"]
au_colors[match(assessment_units$AU_ID, au_colors$AU_ID),]$color
leaflet(assessment_units) %>% addTiles() %>% addPolylines(fillOpacity = 1,
fillColor = ~au_colors[match(assessment_units$AU_ID, au_colors$AU_ID),]$color,
popup = ~paste("<b>", AU_Name, "</b><br>", AU_ID))
leaflet(assessment_units) %>% addTiles() %>% addPolylines(opacity = 1,
color = ~au_colors[match(assessment_units$AU_ID, au_colors$AU_ID),]$color,
popup = ~paste("<b>", AU_Name, "</b><br>", AU_ID))
param_sum <- merge(st_stations_info, status, by = "MLocID")
param_sum <- merge(param_sum, sea_ken, by = c("MLocID","Char_Name"))
View(clack_stations_AWQMS)
clack_param_sum <- parameter_summary(status, seaKen, clack_stations_AWQMS)
param_summary <- clack_param_sum
au_colors <- param_summary %>% group_by(AU_ID) %>% summarise(color = if_else(any(status == "Not Attaining"), "orange", "green"))
param_summary$color <- if_else(status == "Attaining", "green", "orange")
parameter_summary <- function(status, sea_ken, stations){
st_stations <- unique(c(status$MLocID, sea_ken$MLocID))
st_stations_info <- stations %>% dplyr::filter(MLocID %in% st_stations) %>%
dplyr::select(AU_ID, GNIS_Name, MLocID, StationDes)
param_sum <- merge(st_stations_info, status, by = "MLocID")
param_sum <- merge(param_sum, sea_ken, by = c("MLocID","Char_Name"))
param_sum <- dplyr::select(param_sum, AU_ID, GNIS_Name, Char_Name, MLocID, StationDes, status, trend, Lat_DD, Long_DD)
param_sum <- param_sum[order(param_sum[,1], param_sum[,3], param_sum[,4]),]
}
clack_param_sum <- parameter_summary(status, seaKen, clack_stations_AWQMS)
View(clack_data_eco)
source('//deqhq1/WQNPS/Agriculture/Status_and_Trend_Analysis/StatusAndTrends_Package/odeqstatusandtrends/R/parameter_summary.R', echo=TRUE)
clack_param_sum <- parameter_summary(status, seaKen, clack_stations_AWQMS)
param_summary <- clack_param_sum
param_summary$color <- if_else(status == "Attaining", "green", "orange")
param_summary$color <- if_else(status == "Attaining", "green", "orange")
View(param_summary)
param_summary$color <- if_else(param_summary$status == "Attaining", "green", "orange")
leaflet(assessment_units) %>% addTiles() %>%
addPolylines(opacity = 1,
color = ~au_colors[match(assessment_units$AU_ID, au_colors$AU_ID),]$color,
popup = ~paste("<b>", AU_Name, "</b><br>", AU_ID)) %>%
addMarkers(data = param_summary,
lat = param_summary$Lat_DD,
lng = param_summary$Long_DD,
icon = list(iconColor = ~param_summary$color))
View(assessment_units)
